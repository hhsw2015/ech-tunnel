name: Full Cross Compile & Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g. v1.3.0)'
        required: true
        type: string

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    strategy:
      fail-fast: false
      matrix:
        include:
          # ====== 常用平台（无需额外工具链）======
          - goos: linux   ; goarch: amd64
          - goos: linux   ; goarch: arm64
          - goos: linux   ; goarch: arm64   ; file_suffix: android-arm64
          - goos: linux   ; goarch: 386
          - goos: linux   ; goarch: riscv64
          - goos: windows ; goarch: amd64
          - goos: windows ; goarch: arm64
          - goos: windows ; goarch: 386
          - goos: windows ; goarch: arm

          # ====== 需要额外工具链的平台 ======
          # Linux 老 ARM
          - goos: linux   ; goarch: armv5   ; goarm: "5"
          - goos: linux   ; goarch: armv6   ; goarm: "6"
          - goos: linux   ; goarch: armv7   ; goarm: "7"

          # MIPS / MIPS64
          - goos: linux   ; goarch: mips    ; gomips: hard  ; file_suffix: linux-mips-hard
          - goos: linux   ; goarch: mips    ; gomips: soft  ; file_suffix: linux-mips-soft
          - goos: linux   ; goarch: mipsle  ; gomipsle: hard; file_suffix: linux-mipsle-hard
          - goos: linux   ; goarch: mipsle  ; gomipsle: soft; file_suffix: linux-mipsle-soft
          - goos: linux   ; goarch: mips64
          - goos: linux   ; goarch: mips64le

          # BSD 系列
          - goos: freebsd ; goarch: amd64
          - goos: freebsd ; goarch: arm64
          - goos: freebsd ; goarch: 386
          - goos: openbsd ; goarch: amd64
          - goos: openbsd ; goarch: arm64
          - goos: netbsd  ; goarch: amd64
          - goos: netbsd  ; goarch: arm64

          # 其他冷门
          - goos: dragonfly ; goarch: amd64
          - goos: solaris   ; goarch: amd64
          - goos: plan9     ; goarch: amd64
          - goos: plan9     ; goarch: 386

    steps:
      - uses: actions/checkout@v4

      - name: Install cross-compile toolchains
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y gcc-multilib
          # 老 ARM (armv5/armv6)
          sudo apt-get install -y gcc-arm-linux-gnueabi gcc-arm-linux-gnueabihf
          # MIPS
          sudo apt-get install -y gcc-mips-linux-gnu gcc-mipsel-linux-gnu
          # FreeBSD / OpenBSD / NetBSD / Dragonfly / Solaris
          sudo apt-get install -y gcc-freebsd gcc-openbsd gcc-netbsd gcc-dragonfly gcc-illumos || true

      - uses: actions/setup-go@v5
        with:
          go-version: stable

      - run: go mod download

      - name: Build
        env:
          GOOS: ${{ matrix.goos }}
          GOARCH: ${{ matrix.goarch }}
          GOARM: ${{ matrix.goarm }}
          GOMIPS: ${{ matrix.gomips }}
          GOMIPSLE: ${{ matrix.gomipsle }}
          CGO_ENABLED: 1   # 必须开启 CGO 才能用交叉工具链
        run: |
          if [[ "${{ matrix.file_suffix }}" == "android-arm64" ]]; then
            NAME="ech-tunnel-android-arm64"
          else
            SUFFIX="${{ matrix.file_suffix || matrix.goos }}-${{ matrix.goarch }}"
            NAME="ech-tunnel-${SUFFIX}"
          fi
          [[ "$GOOS" == "windows" ]] && NAME="$NAME.exe"

          mkdir -p dist
          echo "Building $NAME ($GOOS/$GOARCH $GOARM $GOMIPS $GOMIPSLE)"
          go build -trimpath -ldflags="-s -w" -o "dist/$NAME" .

      - name: Upload all binaries (only once)
        if: matrix.goos == 'linux' && matrix.goarch == 'amd64'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION=${{ inputs.version }}
          gh release delete "$VERSION" --yes || true
          gh release create "$VERSION" --title="$VERSION" --notes="Full cross-compile release"

          cd dist
          echo "Uploading $(ls -1 | wc -l) binaries..."
          gh release upload "$VERSION" * --clobber
