name: Release All Platforms

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g. v1.5.0)'
        required: true
        type: string

permissions:
  contents: write

jobs:
  # 第一步：创建 Release 并获取 ID（修复 id 问题）
  create-release:
    name: Create Release
    runs-on: ubuntu-latest
    outputs:
      release_id: ${{ steps.create.outputs.release_id }}
    steps:
      - name: Create or update release
        id: create
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION="${{ inputs.version }}"
          # 创建 Release（已存在则更新）
          RELEASE_ID=$(gh release view "$VERSION" --json id --jq .id 2>/dev/null || echo "")
          if [ -z "$RELEASE_ID" ]; then
            gh release create "$VERSION" \
              --title "$VERSION" \
              --notes "Automated full-platform build $(date -u +'%Y-%m-%d %H:%M UTC')" \
              --generate-notes
            RELEASE_ID=$(gh release view "$VERSION" --json id --jq .id)
          fi
          echo "release_id=$RELEASE_ID" >> $GITHUB_OUTPUT
          echo "Release ID: $RELEASE_ID"

      # 可选：标记为 prerelease（现在 id 是纯数字）
      - name: Mark as Prerelease (optional)
        if: always()
        uses: irongut/EditRelease@v1.2.0
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          id: ${{ steps.create.outputs.release_id }}  # 现在是纯数字 ID
          prerelease: true

  # 主力编译任务（5 个并行 job，依赖 create-release）
  build:
    needs: create-release
    runs-on: ubuntu-latest
    strategy:
      matrix:
        target-platform: [ '', 'android', 'freebsd', 'linux_musl', 'linux_musl_all' ]
        include:
          - target-platform: ''
            name: Standard (xgo + windows-arm64)
          - target-platform: android
            name: Android
          - target-platform: freebsd
            name: FreeBSD
          - target-platform: linux_musl
            name: Linux musl (common arches)
          - target-platform: linux_musl_all
            name: Linux musl (all cold arches: mips/loong64/riscv64...)
    name: Build ${{ matrix.name }}
    
    steps:
      - name: Free Disk Space
        uses: jlumbroso/free-disk-space@main
        with:
          android: true
          dotnet: true
          haskell: true
          large-packages: true
          docker-images: true
          swap-storage: true

      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25.0'

      - name: Install tools
        run: |
          sudo apt update -qq
          sudo apt install -y upx-ucl wget unzip jq  # 加 jq 用于 JSON 解析
          docker pull crazymax/xgo:latest
          go install github.com/crazy-max/xgo@latest

      - name: Build ${{ matrix.name }}
        run: |
          chmod +x build.sh
          case "${{ matrix.target-platform }}" in
            "")              bash build.sh release ;;
            android)         bash build.sh release android ;;
            freebsd)         bash build.sh release freebsd ;;
            linux_musl)      bash build.sh release linux_musl ;;
            linux_musl_all)  bash build.sh release linux_musl_all ;;
          esac

      - name: Upload assets (自动覆盖已存在文件)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION="${{ inputs.version }}"
          # 上传所有文件，--clobber 强制覆盖
          cd build/compress
          for file in *; do
            [[ -f "$file" ]] && gh release upload "$VERSION" "$file" --clobber
          done
          echo "Assets uploaded with overwrite!"
